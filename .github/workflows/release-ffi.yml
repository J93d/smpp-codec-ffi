name: Build FFI Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release --package smpp-codec-ffi

      - name: Upload Linux Artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: libsmpp_codec_ffi-linux
          path: target/release/libsmpp_codec_ffi.so

      - name: Upload macOS Artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: libsmpp_codec_ffi-macos
          path: target/release/libsmpp_codec_ffi.dylib

      - name: Upload Windows Artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: smpp_codec_ffi-windows
          path: target/release/smpp_codec_ffi.dll

      - name: Build Python Wheels
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release
          
      - name: Upload Python Wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: target/wheels/*

      - name: Install uniffi-bindgen
        if: matrix.os == 'ubuntu-latest'
        run: cargo install uniffi-bindgen --version 0.28.0

      - name: Generate Bindings
        if: matrix.os == 'ubuntu-latest'
        run: |
          uniffi-bindgen generate --library target/release/libsmpp_codec_ffi.so --language kotlin --out-dir bindings/kotlin
          uniffi-bindgen generate --library target/release/libsmpp_codec_ffi.so --language swift --out-dir bindings/swift

      - name: Upload Kotlin Bindings
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bindings-kotlin
          path: bindings/kotlin

      - name: Upload Swift Bindings
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bindings-swift
          path: bindings/swift
