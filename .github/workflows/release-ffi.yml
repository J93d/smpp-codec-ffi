name: Build FFI Artifacts

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build
        run: cargo build --release --package smpp-codec-ffi

      - name: Upload Linux Artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: libsmpp_codec_ffi-linux
          path: target/release/libsmpp_codec_ffi.so

      - name: Upload macOS Artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: libsmpp_codec_ffi-macos
          path: target/release/libsmpp_codec_ffi.dylib

      - name: Upload Windows Artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: smpp_codec_ffi-windows
          path: target/release/smpp_codec_ffi.dll

      - name: Generate Bindings
        if: matrix.os == 'ubuntu-latest'
        run: |
          cargo run --release --bin uniffi-bindgen generate --library target/release/libsmpp_codec_ffi.so --language kotlin --out-dir bindings/kotlin
          cargo run --release --bin uniffi-bindgen generate --library target/release/libsmpp_codec_ffi.so --language swift --out-dir bindings/swift
          cargo run --release --bin uniffi-bindgen generate --library target/release/libsmpp_codec_ffi.so --language python --out-dir bindings/python

      - name: Upload Kotlin Bindings
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bindings-kotlin
          path: bindings/kotlin

      - name: Upload Swift Bindings
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bindings-swift
          path: bindings/swift

      - name: Upload Python Bindings
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: bindings-python
          path: bindings/python

      - name: Build Python Wheels
        if: matrix.os == 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release --out dist --find-interpreter

      - name: Upload Python Wheels
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: python-wheels
          path: dist

  test-examples:
    name: Test Examples on Ubuntu
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Shared Library
        run: |
          cp artifacts/libsmpp_codec_ffi-linux/libsmpp_codec_ffi.so .
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$(pwd)" >> $GITHUB_ENV

      - name: Test Python Examples
        run: |
          pip install artifacts/python-wheels/*.whl
          # Run server in background
          python examples/python/tool_server.py &
          SERVER_PID=$!
          sleep 2
          # Run client
          python examples/python/tool_client.py
          kill $SERVER_PID

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Test Java Examples
        run: |
          # 1. Download JNA
          curl -L -o jna.jar https://repo1.maven.org/maven2/net/java/dev/jna/jna/5.13.0/jna-5.13.0.jar
          
          # 2. Install Kotlin Compiler
          sudo snap install --classic kotlin
          
          # 3. Compile the generated Kotlin bridge
          # The artifact was downloaded to artifacts/bindings-kotlin/
          kotlinc artifacts/bindings-kotlin/uniffi/smpp_codec_ffi/smpp_codec_ffi.kt \
            -cp jna.jar \
            -include-runtime -d smpp-codec-ffi.jar
          
          # 4. Compile Java Examples
          # We need to make sure the package structure matches: examples/java/ToolClient.java
          # javac -cp "jna.jar:smpp-codec-ffi.jar" examples/java/*.java
          # To keep it simple in CI and avoid package issues, we compile with -d .
          javac -cp "jna.jar:smpp-codec-ffi.jar" -d . examples/java/*.java
          
          # 5. Run Server and Client
          # Run server in background
          java -cp ".:jna.jar:smpp-codec-ffi.jar" -Djava.library.path=. examples.java.ToolServer &
          SERVER_PID=$!
          sleep 3
          
          # Run client
          java -cp ".:jna.jar:smpp-codec-ffi.jar" -Djava.library.path=. examples.java.ToolClient
          
          kill $SERVER_PID
